# diary

### 1.`setTimeout` 最小延迟时间

[为什么 setTimeout 有最小时延 4ms ?为什么 setTimeout 有最小时延 4ms ?](https://mp.weixin.qq.com/s?__biz=MzAxODE2MjM1MA==&mid=2651578171&idx=1&sn=404e2a1803909ab328194068d4792337&chksm=802508fab75281ece593391d7a1dc07597324273016460c68c384e69d80772b044fb07840ef8&scene=27#wechat_redirect)

[HTML Living Standard 8.6 Timers](https://html.spec.whatwg.org/multipage/timers-and-user-prompts.html#timershttps://html.spec.whatwg.org/multipage/timers-and-user-prompts.html#timers)

**1.`timeout` 小于 0 会被设置成0**

```js
// Google Chrome 91.0.4472.114（正式版本） （64 位）
setTimeout(()=>console.log(-9),-9);
setTimeout(()=>console.log(0),0)
// -9 0

setTimeout(()=>console.log(0),0);
setTimeout(()=>console.log(-9),-9);
// 0 -9
```

**2.`timeout` 为 0 不一定是最先执行的**

```js
// Google Chrome 91.0.4472.114（正式版本） （64 位）
setTimeout(()=>console.log(5),5)
setTimeout(()=>console.log(4),4)
setTimeout(()=>console.log(3),3)
setTimeout(()=>console.log(2),2)
setTimeout(()=>console.log(1),1)
setTimeout(()=>console.log(0),0)

// 大概率（40，80%）： 1 0 2 3 4 5
// 有概率（10，20%）： 1 2 0 3 4 5
```

而在 Firefox 中，始终是 `0,1,2,3,4,5` 输出。

**3.4ms延迟**

> [8.6 Timers](https://html.spec.whatwg.org/multipage/timers-and-user-prompts.html#timers)
> 10. If timeout is less than 0, then set timeout to 0.
> 11. If nesting level is greater than 5, and timeout is less than 4, then set timeout to 4.

按照规范所说，出现最小 4 ms 延迟的前提是要超过 5 层的嵌套。

```js
// Google Chrome 91.0.4472.114（正式版本） （64 位）
console.log(+new Date());

setTimeout(() => {
  console.log(55, +new Date())
  setTimeout(() => {
    console.log(44, +new Date())
    setTimeout(() => {
      console.log(33, +new Date())
      setTimeout(() => {
        console.log(22, +new Date())
        setTimeout(() => {
          console.log(11, +new Date())
        }, 1);
      }, 2);
    }, 3);
  }, 4);
}, 5);

// 其他位毫秒数相差不大，唯有第 5 层的实际时间差值比较大，基本大于 4
// 1625357047074
// 55 1625357047081
// 44 1625357047087
// 33 1625357047091
// 22 1625357047095
// 11 1625357047100
```

5 层嵌套（第 5 层）实测数据：

| 实际延迟 | 频数(5)  | 频率(5)  |
| :------: | :---: | :---: |
|    4     |   4   |  8%   |
|    5     |  33   |  66%  |
|    6     |  13   |  26%  |

6 层嵌套（第 5、6 层）实测数据：

| 实际延迟 | 频数（5/6） | 频率（5/6） |
| :------: | :---------: | :---------: |
|    4     |     6/4     |   12%/8%    |
|    5     |    32/41    |   64%/82%   |
|    6     |     9/5     |   18%/10%   |
|    7     |     3/0     |    6%/0%    |

综上，虽然规范说是超过 5 层，但实测（Chrome）中到达 5 层嵌套，就会出现 4 ms 限制。

> 在 Firefox 中，时间差大概率会到达 15 ms 以上。（主测是 chrome，Firefox 辅助，所以没有翔实的数据）

